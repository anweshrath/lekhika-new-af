/**
 * ALCHEMIST MASTER NODES
 * Beautiful nodes with dynamic styling from database
 * Completely isolated from main Flow system
 */

import React, { useState, useEffect } from 'react'
import { Handle, Position } from '@xyflow/react'
import { 
  FileText, Settings, GitBranch, Building2, Download,
  Copy, Save, Play, TestTube, Globe, Eye, Zap, Brain, Trash2, Target, Sparkles, Layers
} from 'lucide-react'
import { alchemistNodePaletteService } from '../../services/alchemistNodePaletteService'
import { alchemistNodeStyleService } from '../../services/alchemistNodeStyleService'
import toast from 'react-hot-toast'

// Hook to get dynamic node styles
const useAlchemistNodeStyles = () => {
  const [nodeStyles, setNodeStyles] = useState({})
  const [isLoading, setIsLoading] = useState(true)

  useEffect(() => {
    const loadStyles = async () => {
      try {
        const styles = await alchemistNodeStyleService.getNodeStyles()
        setNodeStyles(styles)
      } catch (error) {
        console.error('Error loading Alchemist node styles:', error)
        setNodeStyles(alchemistNodeStyleService.getDefaultStyleSchemes())
      } finally {
        setIsLoading(false)
      }
    }

    loadStyles()
  }, [])

  return { nodeStyles, isLoading }
}

// Beautiful Node Template (matching FlowNodes.jsx styling)
const createBeautifulAlchemistNode = (nodeType, defaultIcon = 'âš™ï¸', onDelete = null) => {
  return ({ data, selected }) => {
    const { nodeStyles } = useAlchemistNodeStyles()
    const style = nodeStyles[nodeType] || nodeStyles.inputMaster || {}
    
    const IconComponent = FileText // Default icon component
    const displayIcon = style.icon || defaultIcon
    
    return (
      <div className={`relative transform transition-all duration-300 ${selected ? 'scale-105' : 'hover:scale-102'}`}>
        {/* Connection Handles */}
        <Handle 
          type="target" 
          position={Position.Top} 
          className={`w-4 h-4 !bg-gradient-to-r !${style.handle || 'from-blue-400 to-blue-600'} !border-2 !border-white shadow-lg`} 
        />
        <Handle 
          type="source" 
          position={Position.Right} 
          className={`w-4 h-4 !bg-gradient-to-r !${style.handle || 'from-blue-400 to-blue-600'} !border-2 !border-white shadow-lg`} 
        />
        <Handle 
          type="source" 
          position={Position.Bottom} 
          className={`w-4 h-4 !bg-gradient-to-r !${style.handle || 'from-blue-400 to-blue-600'} !border-2 !border-white shadow-lg`} 
        />
        <Handle 
          type="target" 
          position={Position.Left} 
          className={`w-4 h-4 !bg-gradient-to-r !${style.handle || 'from-blue-400 to-blue-600'} !border-2 !border-white shadow-lg`} 
        />
        
        {/* Node Body - Beautiful light styling like main Flow */}
        <div className={`
          relative bg-gradient-to-br ${style.background || 'from-blue-50 via-blue-100 to-blue-100/90'}
          rounded-2xl shadow-xl border-2 border-dashed transition-all duration-300 min-w-[240px] max-w-[280px]
          ${selected ? 
            `${style.borderSelected || 'border-blue-400 shadow-blue-400/30'}` : 
            `${style.border || 'border-blue-300'} ${style.shadow || 'shadow-blue-300/20'}`
          }
          ${style.borderHover || 'hover:border-blue-400'} ${style.shadowHover || 'hover:shadow-blue-400/40'}
        `}>
          {/* Glow Effect */}
          <div className={`absolute inset-0 bg-gradient-to-br ${style.glow || 'from-blue-200/10'} to-transparent rounded-2xl`} />
          
          {/* Header Section */}
          <div className="relative p-4 pb-3">
            <div className="flex items-center gap-3 mb-3">
              <div className={`p-3 bg-gradient-to-r ${style.gradient || 'from-blue-500 to-blue-700'} backdrop-blur-sm rounded-xl shadow-lg`}>
                <span className="text-white text-xl font-bold drop-shadow-sm">{displayIcon}</span>
              </div>
              <div className="flex-1">
                <h3 className="font-bold text-gray-800 text-lg leading-tight">
                  {data.label || data.name || nodeType.toUpperCase()}
                </h3>
                <p className={`${style.text || 'text-blue-600'} text-sm font-medium`}>
                  {data.description || 'AI-powered processing'}
                </p>
              </div>
              {onDelete && (
                <button
                  onClick={onDelete}
                  className="text-red-400 hover:text-red-300 transition-colors p-1 hover:bg-red-500/10 rounded-lg"
                  title="Delete Node"
                >
                  <Trash2 className="w-4 h-4" />
                </button>
              )}
            </div>
          </div>
          
          {/* Content Section */}
          <div className="relative px-4 pb-4">
            <p className="text-gray-600 text-sm leading-relaxed mb-3">
              {data.description || 'AI-enhanced content processing with dynamic capabilities'}
            </p>
            
            {/* Status Indicators */}
            <div className="flex items-center gap-2 flex-wrap">
              {data.aiEnabled !== false && (
                <span className="flex items-center gap-1 px-2 py-1 bg-yellow-500/20 rounded-full text-xs text-yellow-700 font-medium">
                  <Zap className="w-3 h-3" />
                  AI Enhanced
                </span>
              )}
              {data.features?.length > 0 && (
                <span className="flex items-center gap-1 px-2 py-1 bg-purple-500/20 rounded-full text-xs text-purple-700 font-medium">
                  <Sparkles className="w-3 h-3" />
                  {data.features.length} Features
                </span>
              )}
            </div>
          </div>
          
          {/* Subtle border glow */}
          <div className={`absolute inset-0 rounded-2xl bg-gradient-to-r ${style.textLight || 'from-blue-400/30'} via-transparent ${style.textLight || 'to-blue-400/30'} opacity-0 hover:opacity-100 transition-opacity duration-300 pointer-events-none`} />
        </div>
      </div>
    )
  }
}

// ============================================================================
// MASTER NODES - All using beautiful template
// ============================================================================

// Input Master Node with beautiful styling  
export const InputMasterNode = createBeautifulAlchemistNode('inputMaster', 'ğŸ“')

// Process Master Node with beautiful styling
export const ProcessMasterNode = createBeautifulAlchemistNode('processMaster', 'âš™ï¸')

// Condition Master Node with beautiful styling
export const ConditionMasterNode = createBeautifulAlchemistNode('conditionMaster', 'ğŸ”€')

// Structural Master Node with beautiful styling  
export const StructuralMasterNode = createBeautifulAlchemistNode('structuralMaster', 'ğŸ—ï¸')

// Output Master Node with beautiful styling
export const OutputMasterNode = createBeautifulAlchemistNode('outputMaster', 'ğŸ“¤')

// ============================================================================
// SUB-NODES - All using beautiful template
// ============================================================================

// Input Sub-nodes with beautiful styling
export const DataCollectorNode = createBeautifulAlchemistNode('dataCollector', 'ğŸ“Š')
export const FormBuilderNode = createBeautifulAlchemistNode('formBuilder', 'ğŸ“‹') 
export const VariableManagerNode = createBeautifulAlchemistNode('variableManager', 'ğŸ”§')

// Process Sub-nodes with beautiful styling
export const ContentWriterNode = createBeautifulAlchemistNode('contentWriter', 'âœï¸')
export const ResearchEngineNode = createBeautifulAlchemistNode('researchEngine', 'ğŸ”')
export const QualityOptimizerNode = createBeautifulAlchemistNode('qualityOptimizer', 'âš¡')

// Condition Sub-nodes with beautiful styling
export const LogicGateNode = createBeautifulAlchemistNode('logicGate', 'ğŸšª')
export const DecisionTreeNode = createBeautifulAlchemistNode('decisionTree', 'ğŸŒ³')
export const ValidationCheckNode = createBeautifulAlchemistNode('validationCheck', 'âœ…')

// Structural Sub-nodes with beautiful styling
export const BlueprintDesignerNode = createBeautifulAlchemistNode('blueprintDesigner', 'ğŸ“')
export const TemplateManagerNode = createBeautifulAlchemistNode('templateManager', 'ğŸ“„')
export const LayoutEngineNode = createBeautifulAlchemistNode('layoutEngine', 'ğŸ¨')

// Output Sub-nodes with beautiful styling
export const MultiFormatExporterNode = createBeautifulAlchemistNode('multiFormatExporter', 'ğŸ“¦')
export const PreviewGeneratorNode = createBeautifulAlchemistNode('previewGenerator', 'ğŸ‘ï¸')
export const DeliveryManagerNode = createBeautifulAlchemistNode('deliveryManager', 'ğŸšš')

// ============================================================================
// TEMPLATE-SPECIFIC NODES - All using beautiful template
// ============================================================================

// Content Creation Sub-nodes with beautiful styling
export const BlogPostGeneratorNode = createBeautifulAlchemistNode('blogPostGenerator', 'ğŸ“')
export const VideoScriptWriterNode = createBeautifulAlchemistNode('videoScriptWriter', 'ğŸ¬')
export const CaseStudyWriterNode = createBeautifulAlchemistNode('caseStudyWriter', 'ğŸ“Š')

// Marketing Sub-nodes with beautiful styling
export const EmailSequenceGeneratorNode = createBeautifulAlchemistNode('emailSequenceGenerator', 'ğŸ“§')
export const SocialMediaGeneratorNode = createBeautifulAlchemistNode('socialMediaGenerator', 'ğŸ“±')
export const AdCopyGeneratorNode = createBeautifulAlchemistNode('adCopyGenerator', 'ğŸ“¢')

// Sales Sub-nodes with beautiful styling
export const SalesPageGeneratorNode = createBeautifulAlchemistNode('salesPageGenerator', 'ğŸ’µ')
export const LandingPageGeneratorNode = createBeautifulAlchemistNode('landingPageGenerator', 'ğŸ¯')
export const ProductDescriptionGeneratorNode = createBeautifulAlchemistNode('productDescriptionGenerator', 'ğŸ“')

// PR Sub-node with beautiful styling
export const PressReleaseGeneratorNode = createBeautifulAlchemistNode('pressReleaseGenerator', 'ğŸ“°')

// Export Master Node Types for React Flow
export const alchemistNodeTypes = {
  // Master Nodes
  inputMaster: InputMasterNode,
  processMaster: ProcessMasterNode,
  conditionMaster: ConditionMasterNode,
  structuralMaster: StructuralMasterNode,
  outputMaster: OutputMasterNode,
  
  // Input Sub-nodes
  dataCollector: DataCollectorNode,
  formBuilder: FormBuilderNode,
  variableManager: VariableManagerNode,
  
  // Process Sub-nodes
  contentWriter: ContentWriterNode,
  researchEngine: ResearchEngineNode,
  qualityOptimizer: QualityOptimizerNode,
  
  // Condition Sub-nodes
  logicGate: LogicGateNode,
  decisionTree: DecisionTreeNode,
  validationCheck: ValidationCheckNode,
  
  // Structural Sub-nodes
  blueprintDesigner: BlueprintDesignerNode,
  templateManager: TemplateManagerNode,
  layoutEngine: LayoutEngineNode,
  
  // Output Sub-nodes
  multiFormatExporter: MultiFormatExporterNode,
  previewGenerator: PreviewGeneratorNode,
  deliveryManager: DeliveryManagerNode,
  
  // Alchemist Template-Specific Sub-nodes
  blogPostGenerator: BlogPostGeneratorNode,
  videoScriptWriter: VideoScriptWriterNode,
  caseStudyWriter: CaseStudyWriterNode,
  emailSequenceGenerator: EmailSequenceGeneratorNode,
  socialMediaGenerator: SocialMediaGeneratorNode,
  adCopyGenerator: AdCopyGeneratorNode,
  salesPageGenerator: SalesPageGeneratorNode,
  landingPageGenerator: LandingPageGeneratorNode,
  productDescriptionGenerator: ProductDescriptionGeneratorNode,
  pressReleaseGenerator: PressReleaseGeneratorNode
}

export default alchemistNodeTypes
